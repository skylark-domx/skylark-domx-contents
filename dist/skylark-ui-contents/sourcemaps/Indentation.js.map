{"version":3,"sources":["Indentation.js"],"names":["define","langx","noder","$","contents","Indentation","Evented","inherit","pluginName","prototype","opts","tabIndent","init","editor","_this","this","extend","keystroke","add","e","codeButton","toolbar","findButton","active","indent","shiftKey","isBackward","$blockNodes","nodes","result","selection","startNodes","endNodes","blockNodes","each","i","node","include","j","k","len","n","length","contains","splice","push","blockEl","r","outdentBlock","indentBlock","$blockEl","$childList","$nextTd","$nextTr","$parentLi","$pre","$td","$tr","marginLeft","tagName","is","containerNode","closest","indentText","range","prev","save","parent","children","append","appendTo","restore","parseInt","css","Math","round","indentWidth","classPrefix","next","find","setRangeAtEndOf","text","textNode","toString","replace","document","createTextNode","deleteContents","insertNode","selectNode","setRangeAfter","$parent","$prevTd","$prevTr","outdentText","createRange","setStartBefore","setEndBefore","before","extractContents","insertBefore","after","remove","nextAll","insertAfter","max"],"mappings":"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","file":"../Indentation.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-utils-dom/noder\",\r\n  \"skylark-utils-dom/query\",\r\n  \"./contents\"\r\n],function(langx,noder,$,contents){ \r\n\r\n\r\n  var Indentation = langx.Evented.inherit({\r\n\r\n  });\r\n\r\n\r\n  Indentation.pluginName = 'Indentation';\r\n\r\n  Indentation.prototype.opts = {\r\n    tabIndent: true\r\n  };\r\n\r\n  Indentation.prototype.init = function(editor,opts) {\r\n    this.editor = editor; // this._module;\r\n    this.opts = langx.extend({}, this.opts, opts);\r\n\r\n    this.editor.keystroke.add('tab', '*', (function(_this) {\r\n      return function(e) {\r\n        var codeButton;\r\n        codeButton = _this.editor.toolbar.findButton('code');\r\n        if (!(_this.opts.tabIndent || (codeButton && codeButton.active))) {\r\n          return;\r\n        }\r\n        return _this.indent(e.shiftKey);\r\n      };\r\n    })(this));\r\n  };\r\n\r\n  Indentation.prototype.indent = function(isBackward) {\r\n    var $blockNodes, $endNodes, $startNodes, nodes, result;\r\n    $startNodes = this.editor.selection.startNodes();\r\n    $endNodes = this.editor.selection.endNodes();\r\n    $blockNodes = this.editor.selection.blockNodes();\r\n    nodes = [];\r\n    $blockNodes = $blockNodes.each(function(i, node) {\r\n      var include, j, k, len, n;\r\n      include = true;\r\n      for (j = k = 0, len = nodes.length; k < len; j = ++k) {\r\n        n = nodes[j];\r\n        if (noder.contains(node, n)) {\r\n          include = false;\r\n          break;\r\n        } else if (noder.contains(n, node)) {\r\n          nodes.splice(j, 1, node);\r\n          include = false;\r\n          break;\r\n        }\r\n      }\r\n      if (include) {\r\n        return nodes.push(node);\r\n      }\r\n    });\r\n    $blockNodes = $(nodes);\r\n    result = false;\r\n    $blockNodes.each((function(_this) {\r\n      return function(i, blockEl) {\r\n        var r;\r\n        r = isBackward ? _this.outdentBlock(blockEl) : _this.indentBlock(blockEl);\r\n        if (r) {\r\n          return result = r;\r\n        }\r\n      };\r\n    })(this));\r\n    return result;\r\n  };\r\n\r\n  Indentation.prototype.indentBlock = function(blockEl) {\r\n    var $blockEl, $childList, $nextTd, $nextTr, $parentLi, $pre, $td, $tr, marginLeft, tagName;\r\n    $blockEl = $(blockEl);\r\n    if (!$blockEl.length) {\r\n      return;\r\n    }\r\n    if ($blockEl.is('pre')) {\r\n      $pre = this.editor.selection.containerNode();\r\n      if (!($pre.is($blockEl) || $pre.closest('pre').is($blockEl))) {\r\n        return;\r\n      }\r\n      this.indentText(this.editor.selection.range());\r\n    } else if ($blockEl.is('li')) {\r\n      $parentLi = $blockEl.prev('li');\r\n      if ($parentLi.length < 1) {\r\n        return;\r\n      }\r\n      this.editor.selection.save();\r\n      tagName = $blockEl.parent()[0].tagName;\r\n      $childList = $parentLi.children('ul, ol');\r\n      if ($childList.length > 0) {\r\n        $childList.append($blockEl);\r\n      } else {\r\n        $('<' + tagName + '/>').append($blockEl).appendTo($parentLi);\r\n      }\r\n      this.editor.selection.restore();\r\n    } else if ($blockEl.is('p, h1, h2, h3, h4')) {\r\n      marginLeft = parseInt($blockEl.css('margin-left')) || 0;\r\n      marginLeft = (Math.round(marginLeft / this.opts.indentWidth) + 1) * this.opts.indentWidth;\r\n      $blockEl.css('margin-left', marginLeft);\r\n    } else if ($blockEl.is('table') || $blockEl.is('.' + this.opts.classPrefix +'table')) {\r\n      $td = this.editor.selection.containerNode().closest('td, th');\r\n      $nextTd = $td.next('td, th');\r\n      if (!($nextTd.length > 0)) {\r\n        $tr = $td.parent('tr');\r\n        $nextTr = $tr.next('tr');\r\n        if ($nextTr.length < 1 && $tr.parent().is('thead')) {\r\n          $nextTr = $tr.parent('thead').next('tbody').find('tr:first');\r\n        }\r\n        $nextTd = $nextTr.find('td:first, th:first');\r\n      }\r\n      if (!($td.length > 0 && $nextTd.length > 0)) {\r\n        return;\r\n      }\r\n      this.editor.selection.setRangeAtEndOf($nextTd);\r\n    } else {\r\n      return false;\r\n    }\r\n    return true;\r\n  };\r\n\r\n  Indentation.prototype.indentText = function(range) {\r\n    var text, textNode;\r\n    text = range.toString().replace(/^(?=.+)/mg, '\\u00A0\\u00A0');\r\n    textNode = document.createTextNode(text || '\\u00A0\\u00A0');\r\n    range.deleteContents();\r\n    range.insertNode(textNode);\r\n    if (text) {\r\n      range.selectNode(textNode);\r\n      return this.editor.selection.range(range);\r\n    } else {\r\n      return this.editor.selection.setRangeAfter(textNode);\r\n    }\r\n  };\r\n\r\n  Indentation.prototype.outdentBlock = function(blockEl) {\r\n    var $blockEl, $parent, $parentLi, $pre, $prevTd, $prevTr, $td, $tr, marginLeft, range;\r\n    $blockEl = $(blockEl);\r\n    if (!($blockEl && $blockEl.length > 0)) {\r\n      return;\r\n    }\r\n    if ($blockEl.is('pre')) {\r\n      $pre = this.editor.selection.containerNode();\r\n      if (!($pre.is($blockEl) || $pre.closest('pre').is($blockEl))) {\r\n        return;\r\n      }\r\n      this.outdentText(range);\r\n    } else if ($blockEl.is('li')) {\r\n      $parent = $blockEl.parent();\r\n      $parentLi = $parent.parent('li');\r\n      this.editor.selection.save();\r\n      if ($parentLi.length < 1) {\r\n        range = document.createRange();\r\n        range.setStartBefore($parent[0]);\r\n        range.setEndBefore($blockEl[0]);\r\n        $parent.before(range.extractContents());\r\n        $('<p/>').insertBefore($parent).after($blockEl.children('ul, ol')).append($blockEl.contents());\r\n        $blockEl.remove();\r\n      } else {\r\n        if ($blockEl.next('li').length > 0) {\r\n          $('<' + $parent[0].tagName + '/>').append($blockEl.nextAll('li')).appendTo($blockEl);\r\n        }\r\n        $blockEl.insertAfter($parentLi);\r\n        if ($parent.children('li').length < 1) {\r\n          $parent.remove();\r\n        }\r\n      }\r\n      this.editor.selection.restore();\r\n    } else if ($blockEl.is('p, h1, h2, h3, h4')) {\r\n      marginLeft = parseInt($blockEl.css('margin-left')) || 0;\r\n      marginLeft = Math.max(Math.round(marginLeft / this.opts.indentWidth) - 1, 0) * this.opts.indentWidth;\r\n      $blockEl.css('margin-left', marginLeft === 0 ? '' : marginLeft);\r\n    } else if ($blockEl.is('table') || $blockEl.is('.' + this.opts.classPrefix + 'table')) {\r\n      $td = this.editor.selection.containerNode().closest('td, th');\r\n      $prevTd = $td.prev('td, th');\r\n      if (!($prevTd.length > 0)) {\r\n        $tr = $td.parent('tr');\r\n        $prevTr = $tr.prev('tr');\r\n        if ($prevTr.length < 1 && $tr.parent().is('tbody')) {\r\n          $prevTr = $tr.parent('tbody').prev('thead').find('tr:first');\r\n        }\r\n        $prevTd = $prevTr.find('td:last, th:last');\r\n      }\r\n      if (!($td.length > 0 && $prevTd.length > 0)) {\r\n        return;\r\n      }\r\n      this.editor.selection.setRangeAtEndOf($prevTd);\r\n    } else {\r\n      return false;\r\n    }\r\n    return true;\r\n  };\r\n\r\n  Indentation.prototype.outdentText = function(range) {};\r\n\r\n  return contents.Indentation = Indentation;\r\n\r\n});\r\n"]}