{"version":3,"sources":["InputManager.js"],"names":["define","langx","$","contents","indexOf","InputManager","Evented","inherit","init","editor","opts","selectAllKey","submitKey","_this","this","extend","throttledValueChanged","util","throttle","params","setTimeout","trigger","throttledSelectionChanged","document","on","id","e","triggerEvent","focused","clipboard","pasting","_selectionTimer","clearTimeout","selection","_selection","rangeCount","$rootBlocks","lastCaretPosition","body","children","filter","i","node","isBlockNode","length","save","formatter","format","restore","find","classPrefix","each","el","$el","formatted","parent","is","next","append","phBr","insertAfter","prev","insertBefore","support","onselectionchange","proxy","_onKeyDown","_onKeyPress","_onKeyUp","_onMouseUp","_onFocus","_onBlur","_onDrop","_onInput","browser","firefox","hotkeys","add","preventDefault","modify","os","mac","$children","firstBlock","lastBlock","range","first","get","last","createRange","setStart","setEnd","getNodeLength","closest","click","pluginName","prototype","_modifierKeys","_arrowKeys","addClass","removeClass","$blockEl","getRangeAt","startContainer","undoManager","caretPosition","setRangeAtStartOf","console","log","ref","sync","currentState","caret","ref1","respondTo","keystroke","which","call","metaKey","oninput","p","isEmptyNode","empty","appendTo"],"mappings":"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","file":"../InputManager.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-utils-dom/query\",\r\n  \"./contents\"\r\n],function(langx,$,contents){ \r\n \r\n\r\n  var indexOf = [].indexOf ;\r\n\r\n  var InputManager = langx.Evented.inherit({\r\n    init : function(editor,opts) {\r\n      this.editor = editor;\r\n      this.opts = langx.extend({}, this.opts, opts);\r\n\r\n      var selectAllKey, submitKey;\r\n      this.throttledValueChanged = this.editor.util.throttle((function(_this) {\r\n        return function(params) {\r\n          return setTimeout(function() {\r\n            return _this.editor.trigger('valuechanged', params);\r\n          }, 10);\r\n        };\r\n      })(this), 300);\r\n      this.throttledSelectionChanged = this.editor.util.throttle((function(_this) {\r\n        return function() {\r\n          return _this.editor.trigger('selectionchanged');\r\n        };\r\n      })(this), 50);\r\n      $(document).on('selectionchange.simditor' + this.editor.id, (function(_this) {\r\n        return function(e) {\r\n          var triggerEvent;\r\n          if (!(_this.focused && !_this.editor.clipboard.pasting)) {\r\n            return;\r\n          }\r\n          triggerEvent = function() {\r\n            if (_this._selectionTimer) {\r\n              clearTimeout(_this._selectionTimer);\r\n              _this._selectionTimer = null;\r\n            }\r\n            if (_this.editor.selection._selection.rangeCount > 0) {\r\n              return _this.throttledSelectionChanged();\r\n            } else {\r\n              return _this._selectionTimer = setTimeout(function() {\r\n                _this._selectionTimer = null;\r\n                if (_this.focused) {\r\n                  return triggerEvent();\r\n                }\r\n              }, 10);\r\n            }\r\n          };\r\n          return triggerEvent();\r\n        };\r\n      })(this));\r\n      this.editor.on('valuechanged', (function(_this) {\r\n        return function() {\r\n          var $rootBlocks;\r\n          _this.lastCaretPosition = null;\r\n          $rootBlocks = _this.editor.body.children().filter(function(i, node) {\r\n            return _this.editor.util.isBlockNode(node);\r\n          });\r\n          if (_this.focused && $rootBlocks.length === 0) {\r\n            _this.editor.selection.save();\r\n            _this.editor.formatter.format();\r\n            _this.editor.selection.restore();\r\n          }\r\n          _this.editor.body.find('hr, pre, .' + _this.opts.classPrefix + 'table').each(function(i, el) {\r\n            var $el, formatted;\r\n            $el = $(el);\r\n            if ($el.parent().is('blockquote') || $el.parent()[0] === _this.editor.body[0]) {\r\n              formatted = false;\r\n              if ($el.next().length === 0) {\r\n                $('<p/>').append(_this.editor.util.phBr).insertAfter($el);\r\n                formatted = true;\r\n              }\r\n              if ($el.prev().length === 0) {\r\n                $('<p/>').append(_this.editor.util.phBr).insertBefore($el);\r\n                formatted = true;\r\n              }\r\n              if (formatted) {\r\n                return _this.throttledValueChanged();\r\n              }\r\n            }\r\n          });\r\n          _this.editor.body.find('pre:empty').append(_this.editor.util.phBr);\r\n          if (!_this.editor.util.support.onselectionchange && _this.focused) {\r\n            return _this.throttledSelectionChanged();\r\n          }\r\n        };\r\n      })(this));\r\n      this.editor.body.on('keydown', langx.proxy(this._onKeyDown, this)).on('keypress', langx.proxy(this._onKeyPress, this)).on('keyup', langx.proxy(this._onKeyUp, this)).on('mouseup', langx.proxy(this._onMouseUp, this)).on('focus', langx.proxy(this._onFocus, this)).on('blur', langx.proxy(this._onBlur, this)).on('drop', langx.proxy(this._onDrop, this)).on('input', langx.proxy(this._onInput, this));\r\n      if (this.editor.util.browser.firefox) {\r\n        this.editor.hotkeys.add('cmd+left', (function(_this) {\r\n          return function(e) {\r\n            e.preventDefault();\r\n            _this.editor.selection._selection.modify('move', 'backward', 'lineboundary');\r\n            return false;\r\n          };\r\n        })(this));\r\n        this.editor.hotkeys.add('cmd+right', (function(_this) {\r\n          return function(e) {\r\n            e.preventDefault();\r\n            _this.editor.selection._selection.modify('move', 'forward', 'lineboundary');\r\n            return false;\r\n          };\r\n        })(this));\r\n        selectAllKey = this.editor.util.os.mac ? 'cmd+a' : 'ctrl+a';\r\n        this.editor.hotkeys.add(selectAllKey, (function(_this) {\r\n          return function(e) {\r\n            var $children, firstBlock, lastBlock, range;\r\n            $children = _this.editor.body.children();\r\n            if (!($children.length > 0)) {\r\n              return;\r\n            }\r\n            firstBlock = $children.first().get(0);\r\n            lastBlock = $children.last().get(0);\r\n            range = document.createRange();\r\n            range.setStart(firstBlock, 0);\r\n            range.setEnd(lastBlock, _this.editor.util.getNodeLength(lastBlock));\r\n            _this.editor.selection.range(range);\r\n            return false;\r\n          };\r\n        })(this));\r\n      }\r\n      submitKey = this.editor.util.os.mac ? 'cmd+enter' : 'ctrl+enter';\r\n      this.editor.hotkeys.add(submitKey, (function(_this) {\r\n        return function(e) {\r\n          _this.editor.el.closest('form').find('button:submit').click();\r\n          return false;\r\n        };\r\n      })(this));\r\n    }\r\n\r\n  });\r\n\r\n  InputManager.pluginName = 'InputManager';\r\n\r\n  InputManager.prototype._modifierKeys = [16, 17, 18, 91, 93, 224];\r\n\r\n  InputManager.prototype._arrowKeys = [37, 38, 39, 40];\r\n\r\n\r\n  InputManager.prototype._onFocus = function(e) {\r\n    if (this.editor.clipboard.pasting) {\r\n      return;\r\n    }\r\n    this.editor.el.addClass('focus').removeClass('error');\r\n    this.focused = true;\r\n    return setTimeout((function(_this) {\r\n      return function() {\r\n        var $blockEl, range;\r\n        range = _this.editor.selection._selection.getRangeAt(0);\r\n        if (range.startContainer === _this.editor.body[0]) {\r\n          if (_this.lastCaretPosition) {\r\n            _this.editor.undoManager.caretPosition(_this.lastCaretPosition);\r\n          } else {\r\n            $blockEl = _this.editor.body.children().first();\r\n            range = document.createRange();\r\n            _this.editor.selection.setRangeAtStartOf($blockEl, range);\r\n            console.log(\"aaaaaa\");\r\n          }\r\n        }\r\n        _this.lastCaretPosition = null;\r\n        _this.editor.trigger('focus');\r\n        if (!_this.editor.util.support.onselectionchange) {\r\n          return _this.throttledSelectionChanged();\r\n        }\r\n      };\r\n    })(this), 0);\r\n  };\r\n\r\n  InputManager.prototype._onBlur = function(e) {\r\n    var ref;\r\n    if (this.editor.clipboard.pasting) {\r\n      return;\r\n    }\r\n    this.editor.el.removeClass('focus');\r\n    this.editor.sync();\r\n    this.focused = false;\r\n    this.lastCaretPosition = (ref = this.editor.undoManager.currentState()) != null ? ref.caret : void 0;\r\n    return this.editor.trigger('blur');\r\n  };\r\n\r\n  InputManager.prototype._onMouseUp = function(e) {\r\n    if (!this.editor.util.support.onselectionchange) {\r\n      return this.throttledSelectionChanged();\r\n    }\r\n  };\r\n\r\n  InputManager.prototype._onKeyDown = function(e) {\r\n    var ref, ref1;\r\n    if (this.editor.trigger(e) === false) {\r\n      return false;\r\n    }\r\n    if (this.editor.hotkeys.respondTo(e)) {\r\n      return;\r\n    }\r\n    if (this.editor.keystroke.respondTo(e)) {\r\n      this.throttledValueChanged();\r\n      return false;\r\n    }\r\n    if ((ref = e.which, indexOf.call(this._modifierKeys, ref) >= 0) || (ref1 = e.which, indexOf.call(this._arrowKeys, ref1) >= 0)) {\r\n      return;\r\n    }\r\n    if (this.editor.util.metaKey(e) && e.which === 86) {\r\n      return;\r\n    }\r\n    if (!this.editor.util.support.oninput) {\r\n      this.throttledValueChanged(['typing']);\r\n    }\r\n    return null;\r\n  };\r\n\r\n  InputManager.prototype._onKeyPress = function(e) {\r\n    if (this.editor.trigger(e) === false) {\r\n      return false;\r\n    }\r\n  };\r\n\r\n  InputManager.prototype._onKeyUp = function(e) {\r\n    var p, ref;\r\n    if (this.editor.trigger(e) === false) {\r\n      return false;\r\n    }\r\n    if (!this.editor.util.support.onselectionchange && (ref = e.which, indexOf.call(this._arrowKeys, ref) >= 0)) {\r\n      this.throttledValueChanged();\r\n      return;\r\n    }\r\n    if ((e.which === 8 || e.which === 46) && this.editor.util.isEmptyNode(this.editor.body)) {\r\n      this.editor.body.empty();\r\n      p = $('<p/>').append(this.editor.util.phBr).appendTo(this.editor.body);\r\n      this.editor.selection.setRangeAtStartOf(p);\r\n    }\r\n  };\r\n\r\n  InputManager.prototype._onDrop = function(e) {\r\n    if (this.editor.trigger(e) === false) {\r\n      return false;\r\n    }\r\n    return this.throttledValueChanged();\r\n  };\r\n\r\n  InputManager.prototype._onInput = function(e) {\r\n    return this.throttledValueChanged(['oninput']);\r\n  };\r\n\r\n  return contents.InputManager = InputManager;\r\n\r\n});\r\n"]}